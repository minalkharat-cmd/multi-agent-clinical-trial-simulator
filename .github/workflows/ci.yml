name: CI/CD Pipeline

on:
  push:
      branches: [main, develop]
        pull_request:
            branches: [main, develop]

            env:
              PYTHON_VERSION: "3.11"

              jobs:
                lint:
                    name: Code Quality
                        runs-on: ubuntu-latest
                            steps:
                                  - uses: actions/checkout@v4

                                        - name: Set up Python
                                                uses: actions/setup-python@v5
                                                        with:
                                                                  python-version: ${{ env.PYTHON_VERSION }}

                                                                        - name: Install dependencies
                                                                                run: |
                                                                                          python -m pip install --upgrade pip
                                                                                                    pip install ruff black mypy
                                                                                                    
                                                                                                          - name: Run Ruff
                                                                                                                  run: ruff check src/
                                                                                                                  
                                                                                                                        - name: Run Black
                                                                                                                                run: black --check src/
                                                                                                                                
                                                                                                                                      - name: Run MyPy
                                                                                                                                              run: mypy src/ --ignore-missing-imports
                                                                                                                                              
                                                                                                                                                test:
                                                                                                                                                    name: Tests
                                                                                                                                                        runs-on: ubuntu-latest
                                                                                                                                                            needs: lint
                                                                                                                                                                strategy:
                                                                                                                                                                      matrix:
                                                                                                                                                                              python-version: ["3.10", "3.11", "3.12"]
                                                                                                                                                                              
                                                                                                                                                                                  steps:
                                                                                                                                                                                        - uses: actions/checkout@v4
                                                                                                                                                                                        
                                                                                                                                                                                              - name: Set up Python ${{ matrix.python-version }}
                                                                                                                                                                                                      uses: actions/setup-python@v5
                                                                                                                                                                                                              with:
                                                                                                                                                                                                                        python-version: ${{ matrix.python-version }}
                                                                                                                                                                                                                        
                                                                                                                                                                                                                              - name: Install dependencies
                                                                                                                                                                                                                                      run: |
                                                                                                                                                                                                                                                python -m pip install --upgrade pip
                                                                                                                                                                                                                                                          pip install -e ".[dev]"
                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                - name: Run tests with coverage
                                                                                                                                                                                                                                                                        run: |
                                                                                                                                                                                                                                                                                  pytest --cov=src --cov-report=xml --cov-report=term-missing
                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                        - name: Upload coverage to Codecov
                                                                                                                                                                                                                                                                                                uses: codecov/codecov-action@v3
                                                                                                                                                                                                                                                                                                        with:
                                                                                                                                                                                                                                                                                                                  files: ./coverage.xml
                                                                                                                                                                                                                                                                                                                            fail_ci_if_error: false
                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                              security:
                                                                                                                                                                                                                                                                                                                                  name: Security Scan
                                                                                                                                                                                                                                                                                                                                      runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                                                          steps:
                                                                                                                                                                                                                                                                                                                                                - uses: actions/checkout@v4
                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                      - name: Set up Python
                                                                                                                                                                                                                                                                                                                                                              uses: actions/setup-python@v5
                                                                                                                                                                                                                                                                                                                                                                      with:
                                                                                                                                                                                                                                                                                                                                                                                python-version: ${{ env.PYTHON_VERSION }}
                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                      - name: Install dependencies
                                                                                                                                                                                                                                                                                                                                                                                              run: |
                                                                                                                                                                                                                                                                                                                                                                                                        python -m pip install --upgrade pip
                                                                                                                                                                                                                                                                                                                                                                                                                  pip install bandit safety
                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Run Bandit
                                                                                                                                                                                                                                                                                                                                                                                                                                run: bandit -r src/ -ll
                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                      - name: Check dependencies for vulnerabilities
                                                                                                                                                                                                                                                                                                                                                                                                                                              run: safety check
                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                build:
                                                                                                                                                                                                                                                                                                                                                                                                                                                    name: Build Docker Image
                                                                                                                                                                                                                                                                                                                                                                                                                                                        runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                            needs: [test, security]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                if: github.event_name == 'push' && github.ref == 'refs/heads/main'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    steps:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          - uses: actions/checkout@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - name: Set up Docker Buildx
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        uses: docker/setup-buildx-action@v3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - name: Build Docker image
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      uses: docker/build-push-action@v5
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        context: .
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  push: false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tags: clinical-trial-simulator:latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      cache-from: type=gha
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cache-to: type=gha,mode=max
